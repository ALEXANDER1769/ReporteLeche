<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Reporte de Producci√≥n de Leche - PYSIGA</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
:root {
  --verde: #2f6f4e;
  --azul: #2c4f7c;
  --naranja: #f39c12; /* Color para leche */
  --fondo: #f7f9f8;
}
body {
  font-family: system-ui, Arial;
  background: var(--fondo);
  margin: 0;
  padding: 20px;
}
.container {
  max-width: 1200px;
  margin: auto;
  background: white;
  border-radius: 12px;
  padding: 25px;
  box-shadow: 0 3px 12px rgba(0,0,0,0.1);
}
h1 {
  color: var(--naranja);
  margin-bottom: 15px;
  text-align: center;
}
.kpi-container {
  display: flex;
  justify-content: space-around;
  flex-wrap: wrap;
  gap: 20px;
  margin: 20px 0;
  text-align: center;
}
.kpi-box {
  background: linear-gradient(135deg, #f9f3e9, #f1e0c5);
  padding: 20px;
  border-radius: 10px;
  min-width: 150px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.1);
}
.kpi-value {
  font-size: 36px;
  font-weight: bold;
  color: var(--naranja);
  margin-bottom: 5px;
}
.kpi-label {
  font-size: 14px;
  color: #555;
}
.section {
  margin-bottom: 40px;
}
.section h2 {
  color: var(--azul);
  border-left: 4px solid var(--naranja);
  padding-left: 12px;
  margin-bottom: 20px;
}
.grafico-container {
  background: white;
  border-radius: 10px;
  padding: 20px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.08);
  margin-bottom: 25px;
}
canvas {
  max-width: 100%;
  height: 300px !important;
}
#loader {
  text-align: center;
  padding: 60px 20px;
  font-size: 20px;
  color: var(--azul);
}
.vaca {
  font-size: 60px;
  animation: mover 1.2s infinite alternate;
  margin-bottom: 20px;
}
@keyframes mover {
  from { transform: translateX(-8px) rotate(-5deg); }
  to { transform: translateX(8px) rotate(5deg); }
}
.btn-volver {
  background: var(--azul);
  color: white;
  border: none;
  padding: 12px 24px;
  border-radius: 8px;
  cursor: pointer;
  margin: 30px auto 0;
  font-size: 16px;
  display: block;
  font-weight: bold;
  transition: all 0.2s;
}
.btn-volver:hover {
  background: #1e3a5f;
  transform: translateY(-2px);
  box-shadow: 0 4px 8px rgba(0,0,0,0.15);
}
.btn-volver:active {
  transform: translateY(0);
}
.error {
  color: #c0392b;
  padding: 20px;
  background: #fadbd8;
  border-radius: 10px;
  margin: 30px 0;
  text-align: center;
  font-size: 16px;
  display: none;
  border-left: 4px solid #c0392b;
}

/* === FILTRO TRAYECTORIA INDIVIDUAL === */
.filtro-animal {
  display: flex;
  align-items: center;
  flex-wrap: wrap;
  gap: 10px;
  margin-bottom: 15px;
  padding: 15px;
  background: #f9f9f9;
  border-radius: 8px;
}
.filtro-animal label {
  font-weight: bold;
  color: #555;
}
.filtro-animal select, .filtro-animal input {
  padding: 8px;
  border: 1px solid #ccc;
  border-radius: 4px;
  font-size: 14px;
}
.filtro-animal input {
  flex-grow: 1;
  min-width: 200px;
}
.filtro-animal button {
  background: var(--naranja);
  color: white;
  border: none;
  padding: 8px 16px;
  border-radius: 4px;
  cursor: pointer;
}
.filtro-animal button:hover {
  background: #e67e22;
}
.error-trayectoria {
  color: #c0392b;
  padding: 10px;
  background: #fadbd8;
  border-radius: 6px;
  margin-top: 10px;
  text-align: center;
  display: none;
  border-left: 3px solid #c0392b;
}
</style>
</head>
<body>
<div class="container">
  <h1>ü•õ Reporte de Producci√≥n de Leche</h1>

  <div id="loader">
    <div class="vaca">üêÑ</div>
    <div>Cargando datos de producci√≥n...</div>
  </div>

  <div id="contenido" style="display:none">
    <!-- NUEVA SECCI√ìN: FILTRO DE ANIMAL -->
    <div class="section">
      <h2>Trayectoria Individual de Animal</h2>
      <div class="filtro-animal">
        <label for="selectAnimal">Seleccionar Animal:</label>
        <select id="selectAnimal">
          <option value="">Cargando animales...</option>
        </select>
        <span>O</span>
        <label for="inputIdAnimal">Buscar por ID o N√∫mero Pr√°ctico:</label>
        <input type="text" id="inputIdAnimal" placeholder="Ingrese ID o N√∫mero Pr√°ctico">
        <button id="btnBuscarTrayectoria">Buscar Trayectoria</button>
      </div>
      <div class="grafico-container">
        <canvas id="graficoTrayectoriaIndividual"></canvas>
      </div>
    </div>

    <!-- KPIs -->
    <div class="section">
        <div class="kpi-container">
            <div class="kpi-box">
                <div class="kpi-value" id="kpi-prod-total">0</div>
                <div class="kpi-label">Lts Totales</div>
            </div>
            <div class="kpi-box">
                <div class="kpi-value" id="kpi-prom-dia">0.0</div>
                <div class="kpi-label">Prom. Diario (Lts)</div>
            </div>
            <div class="kpi-box">
                <div class="kpi-value" id="kpi-vacas-prom">0</div>
                <div class="kpi-label">Vacas Orde√±adas (Prom.)</div>
            </div>
            <div class="kpi-box">
                <div class="kpi-value" id="kpi-dias-reg">0</div>
                <div class="kpi-label">D√≠as con Registros</div>
            </div>
        </div>
    </div>

    <!-- Gr√°fico Producci√≥n Diaria -->
    <div class="section">
      <h2>Producci√≥n Diaria de Leche</h2>
      <div class="grafico-container">
        <canvas id="graficoProdDiaria"></canvas>
      </div>
    </div>

    <!-- Gr√°fico Producci√≥n por Av√≠o -->
    <div class="section">
      <h2>Producci√≥n por Turno (Av√≠o)</h2>
      <div class="grafico-container">
        <canvas id="graficoProdAvio"></canvas>
      </div>
    </div>

    <!-- Gr√°fico Top Productores -->
    <div class="section">
      <h2>Top 10 Productores (Promedio)</h2>
      <div class="grafico-container">
        <canvas id="graficoTopProductores"></canvas>
      </div>
    </div>

    <button class="btn-volver" id="btnVolver">‚¨Ö Cerrar reporte y volver al panel</button>
  </div>

  <div id="error" class="error"></div>
</div>

<script>
let datosReporte = {};
let datosInventarioGeneral = [];

document.addEventListener('DOMContentLoaded', function() {
  console.log("üöÄ Iniciando reporte de producci√≥n de leche...");

  const params = new URLSearchParams(window.location.search);
  const email = params.get("email");

  if (!email) {
    mostrarError("Acceso no autorizado. Inicie sesi√≥n desde el panel principal.");
    return;
  }

  console.log("üìß Email:", email);

  // Obtener reporte de producci√≥n y datos de inventario general en paralelo
  Promise.all([
    fetch("https://pysiga.d-alexjose.workers.dev", { // ASEGURATE DE USAR TU URL DE WORKER
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ accion: "reporteProduccionLeche", email: email })
    }),
    fetch("https://pysiga.d-alexjose.workers.dev", { // ASEGURATE DE USAR TU URL DE WORKER
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ accion: "verHoja", email: email, hoja: "Inventario General" })
    })
  ])
  .then(responses => Promise.all(responses.map(r => r.json())))
  .then(([dataLeche, dataInventario]) => {
    console.log("‚úÖ Datos de leche recibidos:", dataLeche);
    console.log("‚úÖ Datos de inventario recibidos:", dataInventario);

    if (!dataLeche.ok) {
      throw new Error(dataLeche.error || "Respuesta inv√°lida del servidor (Leche)");
    }
    if (!dataInventario.ok) {
      throw new Error(dataInventario.error || "Respuesta inv√°lida del servidor (Inventario)");
    }

    datosReporte = dataLeche;

    // Filtrar animales relevantes
    datosInventarioGeneral = dataInventario.filas.filter(animal =>
         animal['Clasificaci√≥n'] === 'VACA PARIDA VACIA' || animal['Clasificaci√≥n'] === 'VACA PARIDA GESTANTE'
    );

    // Actualizar KPIs
    document.getElementById("kpi-prod-total").textContent = datosReporte.kpis.produccionTotal.toFixed(2);
    document.getElementById("kpi-prom-dia").textContent = datosReporte.kpis.promedioDiario.toFixed(2);
    document.getElementById("kpi-vacas-prom").textContent = datosReporte.kpis.vacasPromedioOrde√±adas.toFixed(1);
    document.getElementById("kpi-dias-reg").textContent = datosReporte.kpis.diasConRegistros;

    // Renderizar gr√°ficos
    renderizarGraficoProdDiaria();
    renderizarGraficoProdAvio();
    renderizarGraficoTopProductores();
    renderizarGraficoTrayectoriaIndividual([]); // Vac√≠o inicialmente

    // Cargar el desplegable de animales
    cargarSelectAnimales();

    // Mostrar contenido y ocultar loader
    document.getElementById("loader").style.display = "none";
    document.getElementById("contenido").style.display = "block";

    document.getElementById("btnVolver").addEventListener("click", function() {
      console.log("‚úÖ Cerrando pesta√±a del reporte...");
      window.close();
    });

    document.getElementById("btnBuscarTrayectoria").onclick = function() {
         const idInput = document.getElementById("inputIdAnimal").value.trim();
         if (idInput) {
             buscarDatosTrayectoria(idInput);
             // Intentar seleccionar el ID en el dropdown si coincide
             const select = document.getElementById("selectAnimal");
             for (let i = 0; i < select.options.length; i++) {
                 if (select.options[i].value === idInput) {
                     select.selectedIndex = i;
                     break;
                 }
             }
         } else {
             const selectedId = document.getElementById("selectAnimal").value;
             if (selectedId) {
                 buscarDatosTrayectoria(selectedId);
             } else {
                  renderizarGraficoTrayectoriaIndividual([], "Por favor, seleccione un animal o ingrese un ID/N√∫mero Pr√°ctico.");
             }
         }
    };
  })
  .catch(err => {
    console.error("‚ùå Error:", err);
    mostrarError("Error al cargar los datos: " + err.message);
  });
});

function mostrarError(mensaje) {
  document.getElementById("loader").style.display = "none";
  const err = document.getElementById("error");
  err.textContent = mensaje;
  err.style.display = "block";
}

function cargarSelectAnimales() {
    const select = document.getElementById("selectAnimal");
    select.innerHTML = '<option value="">Seleccione un animal...</option>';

    if (datosInventarioGeneral.length === 0) {
        select.innerHTML = '<option value="">No hay animales disponibles</option>';
        return;
    }

    const animalesOrdenados = datosInventarioGeneral.sort((a, b) => {
        const numA = a['N√∫mero Pr√°ctico'] || a['ID'];
        const numB = b['N√∫mero Pr√°ctico'] || b['ID'];
        if (numA < numB) return -1;
        if (numA > numB) return 1;
        return 0;
    });

    animalesOrdenados.forEach(animal => {
        const option = document.createElement("option");
        const displayName = animal['N√∫mero Pr√°ctico'] || animal['ID'];
        option.value = animal['ID'];
        option.textContent = `${displayName} (${animal['Clasificaci√≥n']})`;
        select.appendChild(option);
    });

    select.onchange = function() {
         const selectedId = this.value;
         if (selectedId) {
             document.getElementById("inputIdAnimal").value = selectedId;
             buscarDatosTrayectoria(selectedId);
         }
    };
}

function buscarDatosTrayectoria(idAnimal) {
    const datosPesaje = datosReporte.pesajeLeche || [];
    const datosFiltrados = datosPesaje.filter(row => row.ID === idAnimal);

    if (datosFiltrados.length === 0) {
        console.log("No se encontraron datos de pesaje para el ID:", idAnimal);
        renderizarGraficoTrayectoriaIndividual([], `No se encontraron datos de producci√≥n para el animal ID: ${idAnimal}`);
        return;
    }

    const datosOrdenados = datosFiltrados.sort((a, b) => new Date(a.Fecha) - new Date(b.Fecha));
    const fechas = datosOrdenados.map(row => row.Fecha);
    const producciones = datosOrdenados.map(row => parseFloat(row.Producci√≥n) || 0);

    renderizarGraficoTrayectoriaIndividual({fechas, producciones});
}

// --- FUNCI√ìN CORREGIDA ---
function renderizarGraficoTrayectoriaIndividual(datos, mensajeError = "") {
    const canvas = document.getElementById("graficoTrayectoriaIndividual");
    const container = canvas.parentElement;

    if (mensajeError) {
        container.innerHTML = `<div class="error-trayectoria">${mensajeError}</div>`;
        return;
    }

    // Correcci√≥n aqu√≠: Verifica si 'datos' existe Y si 'datos.fechas' existe Y su longitud
    if (!datos || !datos.fechas || datos.fechas.length === 0) {
         container.innerHTML = "<p style='text-align:center;color:#999'>Seleccione un animal y presione 'Buscar Trayectoria'</p>";
         return;
    }

    // Limpiar mensaje de error si exist√≠a
    const existingErrorMsg = container.querySelector(".error-trayectoria");
    if (existingErrorMsg) existingErrorMsg.remove();

    // Verificar si ya existe un chart en este canvas y destruirlo
    if (window.trayectoriaChartInstance) window.trayectoriaChartInstance.destroy();

    const ctx = canvas.getContext("2d");
    window.trayectoriaChartInstance = new Chart(ctx, {
        type: 'line',
         {
          labels: datos.fechas,
          datasets: [{
            label: 'Producci√≥n (Lts)',
              data: datos.producciones, // <--- CORREGIDO: Uso expl√≠cito de 'data:'
            borderColor: '#8e44ad',
            backgroundColor: 'rgba(142, 68, 173, 0.1)',
            borderWidth: 3,
            fill: true,
            tension: 0.3,
            pointRadius: 6,
            pointBackgroundColor: '#8e44ad',
            pointHoverRadius: 8,
            pointHoverBackgroundColor: '#1e3a5f'
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false },
            title: {
                display: true,
                text: `Producci√≥n de Leche - ID: ${document.getElementById("selectAnimal").selectedOptions[0]?.text?.split(' ')[0] || document.getElementById("inputIdAnimal").value}`,
                color: '#2c3e50'
            },
            tooltip: {
              callbacks: {
                label: context => `Producci√≥n: ${context.parsed.y} Lts`
              }
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              title: { display: true, text: 'Litros' },
              grid: { color: 'rgba(0,0,0,0.05)' }
            },
            x: {
              title: { display: true, text: 'Fecha' },
              grid: { display: false },
              ticks: { maxRotation: 45, autoSkip: true, maxTicksLimit: 10 }
            }
          }
        }
    });
}
// --- FIN FUNCI√ìN CORREGIDA ---

function renderizarGraficoProdDiaria() {
  const datos = datosReporte.prodDiaria;
  if (datos.length === 0) {
    document.getElementById("graficoProdDiaria").parentElement.innerHTML =
      "<p style='text-align:center;color:#999'>No hay datos de producci√≥n diaria</p>";
    return;
  }

  const fechas = datos.map(d => d.fecha);
  const producciones = datos.map(d => d.produccion);

  const ctx = document.getElementById("graficoProdDiaria").getContext("2d");
  new Chart(ctx, {
    type: 'line',
     {
      labels: fechas,
      datasets: [{
        label: 'Producci√≥n (Lts)',
          data: producciones, // <--- CORREGIDO: Uso expl√≠cito de 'data:'
        borderColor: '#f39c12',
        backgroundColor: 'rgba(243, 156, 18, 0.1)',
        borderWidth: 3,
        fill: true,
        tension: 0.3,
        pointRadius: 5,
        pointBackgroundColor: '#f39c12',
        pointHoverRadius: 7,
        pointHoverBackgroundColor: '#1e3a5f'
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { display: true },
        tooltip: {
          callbacks: {
            label: context => `Producci√≥n: ${context.parsed.y} Lts`
          }
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          title: { display: true, text: 'Litros' },
          grid: { color: 'rgba(0,0,0,0.05)' }
        },
        x: {
          title: { display: true, text: 'Fecha' },
          grid: { display: false },
          ticks: { maxRotation: 45, autoSkip: true, maxTicksLimit: 10 }
        }
      }
    }
  });
}

function renderizarGraficoProdAvio() {
  const datos = datosReporte.prodAvio;
  if (datos.length === 0) {
    document.getElementById("graficoProdAvio").parentElement.innerHTML =
      "<p style='text-align:center;color:#999'>No hay datos por Av√≠o</p>";
    return;
  }

  const datosAgrupados = {};
  datos.forEach(d => {
    if (!datosAgrupados[d.fecha]) {
        datosAgrupados[d.fecha] = { am: 0, pm: 0 };
    }
    if (d.avio === 'am') {
        datosAgrupados[d.fecha].am += d.produccion;
    } else if (d.avio === 'pm') {
        datosAgrupados[d.fecha].pm += d.produccion;
    }
  });

  const fechas = Object.keys(datosAgrupados).sort();
  const produccionAM = fechas.map(fecha => datosAgrupados[fecha].am);
  const produccionPM = fechas.map(fecha => datosAgrupados[fecha].pm);

  const ctx = document.getElementById("graficoProdAvio").getContext("2d");
  new Chart(ctx, {
    type: 'bar',
    data: {
      labels: fechas,
      datasets: [
        {
          label: 'Ma√±ana (AM)',
            data: produccionAM, // <--- CORREGIDO: Uso expl√≠cito de 'data:'
          backgroundColor: '#f1c40f',
          borderColor: '#f39c12',
          borderWidth: 1
        },
        {
          label: 'Tarde (PM)',
            data: produccionPM, // <--- CORREGIDO: Uso expl√≠cito de 'data:'
          backgroundColor: '#e67e22',
          borderColor: '#d35400',
          borderWidth: 1
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { position: 'top' },
        tooltip: {
          callbacks: {
            label: context => `${context.dataset.label}: ${context.parsed.y} Lts`
          }
        }
      },
      scales: {
        y: { beginAtZero: true, title: { display: true, text: 'Litros' } },
        x: { title: { display: true, text: 'Fecha' } }
      }
    }
  });
}

function renderizarGraficoTopProductores() {
  const datos = datosReporte.topProductores;
  if (datos.length === 0) {
    document.getElementById("graficoTopProductores").parentElement.innerHTML =
      "<p style='text-align:center;color:#999'>No hay datos de promedio de productores</p>";
    return;
  }

  const ids = datos.map(d => d.numeroPractico || d.id);
  const promedios = datos.map(d => d.promedioProduccion);

  const ctx = document.getElementById("graficoTopProductores").getContext("2d");
  new Chart(ctx, {
    type: 'bar',
    data: {
      labels: ids,
      datasets: [{
        label: 'Promedio Producci√≥n (Lts/D√≠a)',
          data: promedios, // <--- CORREGIDO: Uso expl√≠cito de 'data:'
        backgroundColor: ids.map((_, i) => `hsl(${i * 30}, 60%, 55%)`),
        borderColor: ids.map((_, i) => `hsl(${i * 30}, 60%, 40%)`),
        borderWidth: 1
      }]
    },
    options: {
      indexAxis: 'y',
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { display: false },
        tooltip: {
          callbacks: {
            label: context => `${context.parsed.x.toFixed(2)} Lts/D√≠a`
          }
        }
      },
      scales: {
        x: { beginAtZero: true, title: { display: true, text: 'Litros por D√≠a' } },
        y: { title: { display: true, text: 'ID Animal' } }
      }
    }
  });
}

</script>
</body>
</html>
